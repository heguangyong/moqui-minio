<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- 创建桶 -->
    <service verb="create" noun="Bucket" type="java"
             location="org.moqui.impl.service.runner.MinioServiceRunner"
             method="createBucket"
             authenticate="true">
        <description>Create a new bucket via MinioServiceRunner</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true">
                <description>Unique identifier for the bucket (also used as MinIO bucket name)</description>
            </parameter>
            <parameter name="userId" type="String" required="true">
                <description>User who will own the bucket</description>
            </parameter>
            <parameter name="bucketName" type="String" required="false">
                <description>Display name for the bucket (defaults to bucketId if not provided)</description>
            </parameter>
            <parameter name="description" type="String" required="false">
                <description>Optional description for the bucket</description>
            </parameter>
            <parameter name="quotaLimit" type="Long" required="false" default-value="5368709120">
                <description>Quota limit in bytes (default: 5GB)</description>
            </parameter>
            <parameter name="isPublic" type="String" required="false" default-value="N">
                <description>Whether the bucket is publicly accessible (Y/N)</description>
            </parameter>
            <parameter name="versioning" type="String" required="false" default-value="N">
                <description>Whether versioning is enabled (Y/N)</description>
            </parameter>
            <parameter name="encryption" type="String" required="false" default-value="N">
                <description>Whether server-side encryption is enabled (Y/N)</description>
            </parameter>
            <parameter name="region" type="String" required="false">
                <description>MinIO region/zone</description>
            </parameter>
            <parameter name="tags" type="String" required="false">
                <description>JSON formatted tags for the bucket</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="bucketId" type="String"/>
            <parameter name="success" type="Boolean"/>
        </out-parameters>
    </service>

    <!-- 删除桶 -->
    <service verb="delete" noun="Bucket" type="java"
             location="org.moqui.impl.service.runner.MinioServiceRunner"
             method="deleteBucket"
             authenticate="true">
        <description>Delete a bucket via MinioServiceRunner</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true">
                <description>Unique identifier for the bucket to delete</description>
            </parameter>
            <parameter name="userId" type="String" required="true">
                <description>User who owns the bucket</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
        </out-parameters>
    </service>

    <!-- 列表桶 -->
    <service verb="list" noun="Bucket" type="java"
             location="org.moqui.impl.service.runner.MinioServiceRunner"
             method="listBucket"
             authenticate="true">
        <description>List buckets - admins can see all buckets by passing null userId, regular users see only their own</description>
        <in-parameters>
            <parameter name="userId" type="String" required="false">
                <description>Filter by specific user (null for admins means show all users' buckets)</description>
            </parameter>
            <parameter name="bucketId" type="String" required="false">
                <description>Filter by bucket ID (partial match)</description>
            </parameter>
            <parameter name="bucketName" type="String" required="false">
                <description>Filter by bucket name (partial match)</description>
            </parameter>
            <parameter name="description" type="String" required="false">
                <description>Filter by description (partial match)</description>
            </parameter>
            <parameter name="status" type="String" required="false">
                <description>Filter by status (ACTIVE, INACTIVE, ERROR, etc.)</description>
            </parameter>
            <parameter name="isPublic" type="String" required="false">
                <description>Filter by public access (Y/N)</description>
            </parameter>
            <parameter name="pageIndex" type="Integer" default-value="0"/>
            <parameter name="pageSize" type="Integer" default-value="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="bucketList" type="List">
                <description>List of bucket information maps</description>
            </parameter>
            <parameter name="bucketListCount" type="Integer">
                <description>Total number of buckets found</description>
            </parameter>
            <parameter name="bucketListPageIndex" type="Integer"/>
            <parameter name="bucketListPageSize" type="Integer"/>
            <parameter name="bucketListPageMaxIndex" type="Integer"/>
            <parameter name="bucketListPageRangeLow" type="Integer"/>
            <parameter name="bucketListPageRangeHigh" type="Integer"/>
            <parameter name="success" type="Boolean"/>
        </out-parameters>
    </service>

    <!-- 更新桶信息 -->
    <service verb="update" noun="Bucket" type="java"
             location="org.moqui.impl.service.runner.MinioServiceRunner"
             method="updateBucket"
             authenticate="true">
        <description>Update bucket information</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
            <parameter name="bucketName" type="String" required="false"/>
            <parameter name="description" type="String" required="false"/>
            <parameter name="quotaLimit" type="Long" required="false"/>
            <parameter name="tags" type="String" required="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
        </out-parameters>
    </service>

    <!-- 获取桶详细信息 -->
    <service verb="get" noun="Bucket" type="java"
             location="org.moqui.impl.service.runner.MinioServiceRunner"
             method="getBucket"
             authenticate="true">
        <description>Get detailed bucket information</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="bucketInfo" type="Map"/>
            <parameter name="success" type="Boolean"/>
        </out-parameters>
    </service>

    <!-- ==================== V2 统一响应格式服务 ==================== -->

    <service verb="list" noun="BucketV2" authenticate="true" allow-remote="true">
        <description>List buckets with unified response format V2</description>
        <in-parameters>
            <parameter name="userId" type="String" required="false"/>
            <parameter name="bucketId" type="String" required="false"/>
            <parameter name="bucketName" type="String" required="false"/>
            <parameter name="status" type="String" required="false"/>
            <parameter name="isPublic" type="String" required="false"/>
            <parameter name="pageIndex" type="Integer" default-value="0"/>
            <parameter name="pageSize" type="Integer" default-value="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original list service
                Map listResult = ec.service.sync().name("minio.MinioServices.list#Bucket")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioListResponse")
                    .parameters([
                        items: listResult.bucketList ?: [],
                        total: listResult.bucketListCount ?: 0,
                        page: (listResult.bucketListPageIndex ?: 0) + 1,
                        limit: listResult.bucketListPageSize ?: 20
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="create" noun="BucketV2" authenticate="true" allow-remote="true">
        <description>Create bucket with unified response format V2</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
            <parameter name="bucketName" type="String" required="false"/>
            <parameter name="description" type="String" required="false"/>
            <parameter name="quotaLimit" type="Long" required="false"/>
            <parameter name="isPublic" type="String" required="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original create service
                Map createResult = ec.service.sync().name("minio.MinioServices.create#Bucket")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioBucketResponse")
                    .parameters([
                        bucketData: [bucketId: createResult.bucketId, success: createResult.success],
                        bucketName: bucketId,
                        operation: "create"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="get" noun="BucketV2" authenticate="true" allow-remote="true">
        <description>Get bucket info with unified response format V2</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original get service
                Map getResult = ec.service.sync().name("minio.MinioServices.get#Bucket")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioBucketResponse")
                    .parameters([
                        bucketData: getResult.bucketInfo,
                        bucketName: bucketId,
                        operation: "read"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="update" noun="BucketV2" authenticate="true" allow-remote="true">
        <description>Update bucket with unified response format V2</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
            <parameter name="bucketName" type="String" required="false"/>
            <parameter name="description" type="String" required="false"/>
            <parameter name="quotaLimit" type="Long" required="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original update service
                Map updateResult = ec.service.sync().name("minio.MinioServices.update#Bucket")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioBucketResponse")
                    .parameters([
                        bucketData: [success: updateResult.success],
                        bucketName: bucketId,
                        operation: "update"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="delete" noun="BucketV2" authenticate="true" allow-remote="true">
        <description>Delete bucket with unified response format V2</description>
        <in-parameters>
            <parameter name="bucketId" type="String" required="true"/>
            <parameter name="userId" type="String" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original delete service
                Map deleteResult = ec.service.sync().name("minio.MinioServices.delete#Bucket")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioBucketResponse")
                    .parameters([
                        bucketData: [success: deleteResult.success],
                        bucketName: bucketId,
                        operation: "delete"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

</services>