<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- ==================== MinIO组件统一REST API响应包装服务 ==================== -->

    <service verb="wrap" noun="MinioApiResponse" authenticate="false" allow-remote="true">
        <description>MinIO组件统一REST API响应格式包装服务</description>
        <in-parameters>
            <parameter name="data" type="Object" required="false">
                <description>MinIO业务数据对象</description>
            </parameter>
            <parameter name="success" type="Boolean" default="true">
                <description>操作是否成功</description>
            </parameter>
            <parameter name="code" type="Integer" default="200">
                <description>HTTP状态码</description>
            </parameter>
            <parameter name="message" type="String" default="MinIO操作成功">
                <description>提示消息</description>
            </parameter>
            <parameter name="errors" type="List" required="false">
                <description>错误信息列表</description>
            </parameter>
            <parameter name="bucketName" type="String" required="false">
                <description>操作的桶名称</description>
            </parameter>
            <parameter name="objectKey" type="String" required="false">
                <description>操作的对象键</description>
            </parameter>
            <parameter name="operation" type="String" required="false">
                <description>执行的操作类型</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map">
                <description>标准化的MinIO REST响应</description>
            </parameter>
        </out-parameters>
        <actions>
            <script><![CDATA[
                import groovy.json.JsonOutput
                import java.util.UUID

                // 生成请求ID
                String actualRequestId = "minio_req_${UUID.randomUUID().toString().substring(0, 8)}"

                // 构建标准响应结构
                Map standardResponse = [:]
                standardResponse.success = success ?: true
                standardResponse.code = code ?: 200
                standardResponse.message = message ?: (success ? "MinIO操作成功" : "MinIO操作失败")

                // MinIO业务数据
                if (data != null) {
                    standardResponse.data = data
                }

                // 错误信息处理
                if (errors && !errors.isEmpty()) {
                    standardResponse.errors = errors
                    standardResponse.success = false
                    if (!code || code == 200) {
                        standardResponse.code = 400
                    }
                }

                // MinIO专用元数据
                Map meta = [:]
                meta.timestamp = ec.user.nowTimestamp.time
                meta.requestId = actualRequestId
                meta.version = "1.0"
                meta.component = "MinIO-Object-Storage"
                meta.server = "Moqui-MinIO-${ec.web.request.serverName}"

                // MinIO特有信息
                if (bucketName) meta.bucketName = bucketName
                if (objectKey) meta.objectKey = objectKey
                if (operation) meta.operation = operation
                meta.storageProvider = "MinIO"

                standardResponse.meta = meta

                response = standardResponse

                // 错误时设置HTTP状态码
                if (!success || (errors && !errors.isEmpty())) {
                    ec.web.response.setStatus(code ?: 400)
                }
            ]]></script>
        </actions>
    </service>

    <service verb="wrap" noun="MinioBucketResponse" authenticate="false" allow-remote="true">
        <description>MinIO桶操作响应包装</description>
        <in-parameters>
            <parameter name="bucketData" type="Object" required="true">
                <description>桶数据</description>
            </parameter>
            <parameter name="bucketName" type="String" required="false">
                <description>桶名称</description>
            </parameter>
            <parameter name="operation" type="String" required="true">
                <description>操作类型（create/update/delete/list）</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map">
                <description>标准化的桶操作响应</description>
            </parameter>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // 调用统一包装服务
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioApiResponse")
                    .parameters([
                        data: bucketData,
                        success: true,
                        code: 200,
                        message: "桶操作成功",
                        bucketName: bucketName,
                        operation: operation
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="wrap" noun="MinioErrorResponse" authenticate="false" allow-remote="true">
        <description>MinIO错误响应包装</description>
        <in-parameters>
            <parameter name="errorMessage" type="String" required="true">
                <description>错误消息</description>
            </parameter>
            <parameter name="errorCode" type="Integer" default="500">
                <description>错误代码</description>
            </parameter>
            <parameter name="bucketName" type="String" required="false">
                <description>相关桶名称</description>
            </parameter>
            <parameter name="minioErrorDetails" type="Map" required="false">
                <description>MinIO错误详情</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map">
                <description>标准化的MinIO错误响应</description>
            </parameter>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // 构建错误信息列表
                List errorList = []
                errorList.add(errorMessage)

                Map errorData = null
                if (minioErrorDetails) {
                    errorData = [minioError: minioErrorDetails]
                }

                // 调用统一包装服务
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioApiResponse")
                    .parameters([
                        data: errorData,
                        success: false,
                        code: errorCode,
                        message: errorMessage,
                        errors: errorList,
                        bucketName: bucketName
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="wrap" noun="MinioListResponse" authenticate="false" allow-remote="true">
        <description>MinIO列表响应包装</description>
        <in-parameters>
            <parameter name="items" type="List" required="true">
                <description>桶或对象列表</description>
            </parameter>
            <parameter name="total" type="Long" required="false">
                <description>总数量</description>
            </parameter>
            <parameter name="page" type="Integer" default="1">
                <description>当前页</description>
            </parameter>
            <parameter name="limit" type="Integer" default="20">
                <description>每页大小</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map">
                <description>标准化的列表响应</description>
            </parameter>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // 计算分页信息
                Long actualTotal = total ?: (items ? items.size() : 0)
                Integer pageCount = limit > 0 ? Math.ceil(actualTotal / limit) as Integer : 1

                // 构建列表数据结构
                Map listData = [:]
                listData.items = items ?: []
                listData.count = items ? items.size() : 0

                // 调用统一包装服务
                Map wrapResult = ec.service.sync().name("minio.ApiResponseServices.wrap#MinioApiResponse")
                    .parameters([
                        data: listData,
                        success: true,
                        code: 200,
                        message: "列表查询成功",
                        operation: "list"
                    ]).call()

                // 添加分页信息到meta
                wrapResult.response.meta.pagination = [
                    total: actualTotal,
                    page: page,
                    limit: limit,
                    pageCount: pageCount
                ]

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

</services>