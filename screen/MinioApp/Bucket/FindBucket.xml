<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="${ec.l10n.localize('Bucket Management')}"
        default-menu-index="10"
        default-menu-include="true"
        require-authentication="true">

    <transition name="createBucket">
        <service-call name="minio.MinioServices.create#Bucket"/>
        <default-response url="."/>
    </transition>
    <transition name="updateBucket">
        <service-call name="minio.MinioServices.update#Bucket"/>
        <default-response url="."/>
    </transition>
    <transition name="deleteBucket">
        <service-call name="minio.MinioServices.delete#Bucket"/>
        <default-response url="."/>
    </transition>
    <transition name="bucketDetail">
        <parameter name="bucketId"/>
        <actions>
            <log level="info" message="=== Bucket Detail Navigation Debug ==="/>
            <log level="info" message="bucketId parameter: ${bucketId}"/>
            <log level="info" message="Current screen path: ${ec.screen.location}"/>
            <log level="info" message="Target URL: BucketDetail"/>
            <log level="info" message="====================================="/>

            <!-- 验证参数 -->
            <if condition="!bucketId">
                <then>
                    <message error="true">Missing bucketId parameter</message>
                    <default-response url="."/>
                    <return/>
                </then>
            </if>
        </actions>
        <default-response url="BucketDetail"/>  <!-- 简化路径 -->
    </transition>

    <actions>
        <set field="userId" from="ec.user.userId"/>
        <set field="isAdmin" from="ec.user.isInGroup('ADMIN') || ec.user.isInGroup('ADMIN_ADV')"/>
        <set field="scope" from="scope ?: 'user'"/>
        <service-call name="minio.MinioServices.list#Bucket"
                      in-map="[userId:userId, scope:scope, pageIndex:pageIndex, pageSize:pageSize, bucketName:bucketName]"
                      out-map="context"/>
    </actions>

    <widgets>
            <!-- Bucket Management Header -->
        <container><label text="${ec.l10n.localize('Bucket Management')}" type="h2"/></container>

            <!-- Toolbar -->
            <container>
                <container-dialog id="CreateBucketDialog" button-text="${ec.l10n.localize('Create Bucket')}" type="primary">
                    <form-single name="CreateBucketForm" transition="createBucket">
                        <!-- Hidden fields -->
                        <field name="isCreate"><default-field><hidden default-value="true"/></default-field></field>
                        <field name="userId"><default-field><hidden default-value="${ec.user.userId}"/></default-field></field>

                        <!-- Visible fields -->
                        <field name="bucketId">
                            <default-field title="${ec.l10n.localize('Bucket ID')}">
                                <text-line size="30" maxlength="63"/>
                            </default-field>
                        </field>

                        <field name="bucketName">
                            <default-field title="${ec.l10n.localize('Bucket Name')}">
                                <text-line size="30"/>
                            </default-field>
                        </field>

                        <field name="description">
                            <default-field title="${ec.l10n.localize('Description')}">
                                <text-area rows="3" cols="50"/>
                            </default-field>
                        </field>

                        <field name="submitButton">
                            <default-field title="">
                                <submit text="${ec.l10n.localize('Create')}"/>
                            </default-field>
                        </field>
                    </form-single>
                </container-dialog>

                <section name="adminView" condition="isAdmin">
                    <widgets>
                        <container>
                            <link url="." text="${ec.l10n.localize('查看我的网盘')}" parameter-map="[scope:'user']" condition="scope == 'all'"/>
                            <link url="." text="${ec.l10n.localize('查看所有网盘')}" parameter-map="[scope:'all']" condition="scope != 'all'"/>
                        </container>
                    </widgets>
                </section>
            </container>

            <!-- Content -->
            <container>
            <!-- Search Form -->
            <form-single name="SearchForm" transition="." map="ec.web.parameters">
                <field name="bucketName">
                    <default-field title="${ec.l10n.localize('Bucket Name')}">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="submitButton">
                    <default-field title="${ec.l10n.localize('Search')}">
                        <submit/>
                    </default-field>
                </field>

                <field-layout>
                    <field-row>
                        <field-ref name="bucketName"/>
                        <field-ref name="submitButton"/>
                    </field-row>
                </field-layout>
            </form-single>

            <!-- Bucket List -->
            <form-list name="ListBuckets" list="bucketList" paginate="true" skip-form="true">
                <field name="bucketId">
                    <header-field title="${ec.l10n.localize('Bucket ID')}"/>
                    <default-field><display/></default-field>
                </field>
                <field name="bucketName">
                    <header-field title="${ec.l10n.localize('Bucket Name')}"/>
                    <default-field>
                        <link url="bucketDetail" text="${bucketName}" link-type="anchor">
                            <parameter name="bucketId" from="bucketId"/>
                        </link>
                    </default-field>
                </field>
                <field name="quotaLimit">
                    <header-field title="${ec.l10n.localize('Quota Limit (Bytes)')}"/>
                    <default-field><display/></default-field>
                </field>
                <field name="createdDate">
                    <header-field title="${ec.l10n.localize('Created Date')}"/>
                    <default-field><display format="yyyy-MM-dd HH:mm:ss"/></default-field>
                </field>
                <field name="actions">
                    <header-field title="${ec.l10n.localize('Actions')}"/>
                    <default-field>
                        <link url="deleteBucket" text="${ec.l10n.localize('Delete')}" confirmation="确定要删除这个网盘吗？删除后将无法恢复。">
                            <parameter name="bucketId" from="bucketId"/>
                        </link>
                        <container-dialog id="EditBucketDialog_${bucketId}" button-text="${ec.l10n.localize('Edit')}">
                            <form-single name="EditBucketForm" transition="updateBucket" map="bucketList_entry">
                                <!-- Hidden fields -->
                                <field name="bucketId"><default-field><hidden/></default-field></field>
                                <field name="userId"><default-field><hidden default-value="${ec.user.userId}"/></default-field></field>

                                <!-- Editable fields -->
                                <field name="bucketName">
                                    <default-field title="${ec.l10n.localize('Bucket Name')}">
                                        <text-line size="30"/>
                                    </default-field>
                                </field>

                                <field name="description">
                                    <default-field title="${ec.l10n.localize('Description')}">
                                        <text-area rows="3" cols="50"/>
                                    </default-field>
                                </field>

                                <field name="quotaLimit">
                                    <default-field title="${ec.l10n.localize('Quota Limit (Bytes)')}">
                                        <text-line size="20"/>
                                    </default-field>
                                </field>

                                <field name="submitButton">
                                    <default-field title="">
                                        <submit text="${ec.l10n.localize('Update')}"/>
                                    </default-field>
                                </field>
                            </form-single>
                        </container-dialog>
                    </default-field>
                </field>
            </form-list>
            </container>
    </widgets>
</screen>
